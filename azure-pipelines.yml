trigger: none

pool:
  name: sid-agent-pool

variables:
  tfDir: '$(System.DefaultWorkingDirectory)/Terraform/rg-ceating'

jobs:
# -------------------------
# Job 1: Terraform Init + Plan
# -------------------------
- job: TerraformPlan
  displayName: "Terraform Init and Plan"
  steps:
    # Install Terraform
    - task: TerraformInstaller@1
      inputs:
        terraformVersion: 'latest'

    # Terraform init
    - task: TerraformTask@5
      inputs:
        provider: 'azurerm'
        command: 'init'
        workingDirectory: '$(tfDir)'
        backendServiceArm: 'my-connection'
        backendAzureRmStorageAccountName: 'siddharthsa11'
        backendAzureRmContainerName: 'sid'
        backendAzureRmKey: 'terra.tfstate'

    # Terraform plan
    - task: TerraformTask@5
      inputs:
        provider: 'azurerm'
        command: 'plan'
        workingDirectory: '$(tfDir)'
        environmentServiceNameAzureRM: 'my-connection'

# -------------------------
# Job 2: Manual Approval
# -------------------------
- job: ManualApproval
  displayName: "Manual Approval for Apply"
  dependsOn: TerraformPlan
  condition: and(succeeded(), eq(variables['Build.SourceBranchName'], 'main'))
  pool: server
  steps:
    - task: ManualValidation@0
      inputs:
        instructions: "Please approve to apply Terraform changes in main branch"
        onTimeout: 'reject'
        timeout: '1d'

# -------------------------
# Job 3: Terraform Apply
# -------------------------
- job: TerraformApply
  displayName: "Terraform Apply"
  dependsOn: ManualApproval
  condition: succeeded()
  steps:
    - task: TerraformInstaller@1
      inputs:
        terraformVersion: 'latest'

    - task: TerraformTask@5
      inputs:
        provider: 'azurerm'
        command: 'apply'
        workingDirectory: '$(tfDir)'
        environmentServiceNameAzureRM: 'my-connection'
